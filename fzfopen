#!/usr/bin/env sh

printhelp() {
    printf "%s\n\t\t%s\n%s\n\t\t%s\n" \
        "-h, --help" \
                "print this help message, then exit" \
        "-r, --read-only" \
                "print the file to stdout instead of xdg-opening it"
}

setfile() {
    file="$( fzf )"
}

openfile() {
    [ "$file" ] || return

    xdg-open "$file"

#    # This is a workaround for xdg-open not working as intended.
#    extension="$( echo "$file" | sed 's/.*\.//' )"
#    case "$extension" in
##       pdf)
##            zathura "$file" &
##            ;;
#        *)
#            xdg-open "$file"
#            ;;
#    esac
}

for i in "$@"
do
    [ "${i:0:1}" = "-" ] && {
        if ! [ "${i:1:1}" = "-" ]
        then
            sopt="${i:1}"

            while [ "$sopt" ]
            do
                opt="${sopt:0:1}"

                case "$opt" in
                    r)
                        ro=1
                        ;;
                    h)
                        printhelp
                        exit 0
                        ;;
                    *)
                        echo "-$opt is not a valid option, exiting."
                        exit 1
                        ;;
                esac

                sopt="${sopt:1}"
            done
        else
            lopt="${i:2}"
            
            case "$lopt" in
                read-only)
                    ro=1
                    ;;
                help)
                    printhelp
                    exit 0
                    ;;
                *)
                    echo "--$lopt is not a valid option, exiting."
                    exit 1
                    ;;
            esac
        fi
    }
done

if ! [ "$@" ]
then
    setfile
    openfile
else
    for i in "$@"
    do
        [ "${i:0:1}" = "-" ] && continue

        loc="$( getloc "$i" )"

        [ "$loc" ] && {
            cd "$loc" || continue

            setfile

            [ "$file" ] || continue

            if [ "$ro" = 1 ]
            then
                echo "$file"
            else
                openfile
            fi
        }
    done
fi
