#!/usr/bin/env zsh

devs="$( bluetoothctl paired-devices | awk '{print $2}' )"
cdevs=""

echo "$devs" | while read -r i
do
    [ "$( qdbus --system org.bluez "/org/bluez/hci0/dev_$( echo "$i" | sed 's/:/_/g' )" org.bluez.Device1.Connected )" = "true" ] && cdevs="$( printf "%s%s\n" "$cdevs" "$i" )"
done

# if sh is used instead of zsh, this part always exits
# find a fix and use sh
[ "$cdevs" = "" ] && {
    echo "No connected device, exiting."
    exit
}

if [ "$( echo "$cdevs" | wc -l )" = 1 ]
then
    ddev="$cdevs"
else
    ddev="$( echo "$cdevs" | dmenu -i -p "Device to disconnect:" )"
    [ "$ddev" = "" ] && exit
fi

ddevname="$( bluetoothctl info "$i" | grep -m 1 Alias: | sed 's/.*Alias:\s*//' )"

if bluetoothctl disconnect "$ddev"
then
    notify-send -t 1000 "✔  $ddevname" "Device disconnected."
else
    notify-send -t 1000 "❌ $ddevname" "Could not disconnect device."
fi

statbarset
