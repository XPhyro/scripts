#!/usr/bin/env sh

compile() {
    # Adapted from https://tex.stackexchange.com/a/8792/199300
    pdflatex -draftmode -halt-on-error "$fl"
    bibtex "$fl"
    makeindex "$fl".idx
    # makeindex -s style.gls ...
    pdflatex -draftmode -halt-on-error "$fl"
    pdflatex -halt-on-error "$fl"
}

if [ "$1" = "" ]
then
    fl="main"
    echo "No file name given, assuming main."
else
    fl="$( echo "$1" | sed 's/\.tex$//' )"
fi


[ -f "$fl.tex" ] || {
    echo "No such file exists."
    exit
}

compile

[ "$( ps aux | grep "zathura $fl.pdf" | grep -v "grep.*zathura $fl.pdf" )" = "" ] && zathura "$fl.pdf" &

while true
do
    inotifywait "$fl.tex"

    while [ ! -f "main.tex" ]; do sleep 0.1s; done

    compile

    while [ ! -f "main.tex" ]; do sleep 0.1s; done
done
