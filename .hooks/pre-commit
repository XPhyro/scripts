#!/usr/bin/env sh

git diff --cached --name-only \
    | grep -E "^src/c(pp)?/.*\.[ch](pp)?$" \
    | while IFS= read -r fl; do
        realfl="$PWD/$fl"
        [ -e "$realfl" ] || continue
        flcontent="$(cat -- "$realfl")"
        (cd "$(dirname -- "$realfl")" \
             && clang-format -i --style=file -- "$realfl" \
             && [ "$GIT_PRE_COMMIT_NO_ADD" -ne 0 ] \
             && git add -- "$realfl"
        )
        printf "%s\n" "$flcontent" | cmp -s -- "$realfl" \
            && printf "Formatted file %s\n" "$(basename -- "$realfl")"
    done
